#!/usr/bin/env node

// ===================================================
// TEST COMMUNITY POST
// ===================================================
// Cria um post de teste no Supabase para validar a integra√ß√£o
// ===================================================

import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://nranmngyocaqjwcokcxm.supabase.co';
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_SERVICE_KEY) {
  console.error('‚ùå SUPABASE_SERVICE_ROLE_KEY n√£o encontrada');
  console.log('Por favor, configure a vari√°vel de ambiente');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

async function createTestPost() {
  try {
    console.log('\nüé® Criando post de teste na comunidade...\n');

    // Primeiro, vamos buscar um usu√°rio para associar ao post
    const { data: users, error: usersError } = await supabase
      .from('users')
      .select('id, email')
      .limit(1);

    if (usersError) {
      console.error('Erro ao buscar usu√°rio:', usersError);
      return;
    }

    if (!users || users.length === 0) {
      console.log('‚ö†Ô∏è  Nenhum usu√°rio encontrado. Criando post com user_id fict√≠cio.');
    }

    const userId = users && users.length > 0 ? users[0].id : '00000000-0000-0000-0000-000000000000';

    // Criar post de teste (imagem)
    const testImagePost = {
      user_id: userId,
      type: 'image',
      title: 'Test AI Image',
      description: 'This is a test image generated by DUA AI',
      media_url: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=800&q=80',
      firebase_path: 'test/image-1.png'
    };

    const { data: imagePost, error: imageError } = await supabase
      .from('community_posts')
      .insert(testImagePost)
      .select()
      .single();

    if (imageError) {
      console.error('‚ùå Erro ao criar post de imagem:', imageError);
    } else {
      console.log('‚úÖ Post de imagem criado:', imagePost.id);
    }

    // Criar post de teste (m√∫sica)
    const testMusicPost = {
      user_id: userId,
      type: 'music',
      title: 'Test AI Music',
      description: 'This is a test music generated by DUA AI',
      media_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
      firebase_path: 'test/music-1.mp3'
    };

    const { data: musicPost, error: musicError } = await supabase
      .from('community_posts')
      .insert(testMusicPost)
      .select()
      .single();

    if (musicError) {
      console.error('‚ùå Erro ao criar post de m√∫sica:', musicError);
    } else {
      console.log('‚úÖ Post de m√∫sica criado:', musicPost.id);
    }

    // Verificar posts criados
    const { data: allPosts, error: postsError } = await supabase
      .from('community_posts')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(5);

    if (postsError) {
      console.error('‚ùå Erro ao buscar posts:', postsError);
    } else {
      console.log(`\nüìä Total de posts na comunidade: ${allPosts.length}`);
      console.log('\n√öltimos posts:');
      allPosts.forEach(post => {
        console.log(`  - [${post.type}] ${post.title} (${post.id})`);
      });
    }

    console.log('\n‚úÖ Teste conclu√≠do! Acesse /community para ver os posts.\n');

  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
}

createTestPost();
